---
title: "branchmodel_basics"
author: "Eric Kernfeld"
date: "March 30, 2017"
output: html_document
---

####Data-fetching
 
```{r}
setMethod( "nrow" , signature(x = "branchmodel"), function(x) {return(nrow(x@raw_data))} )
setMethod( "ncol", signature(x = "branchmodel"), function(x) {return(ncol(x@raw_data))} )
```

####Plotting, `show`ing, and manipulation

```{r}
# # Show only the dimensions of the data and the centers/tips
setMethod("show",
          signature = signature(object = "branchmodel"),
          definition = function( object ) {
            cat("An object of class ", class(object), "\n", sep = "")
            cat(" ", ncol(object), " variables and ",
                nrow(object), " samples.\n", sep = "")
            cat("Centered at: \n",  paste( object@center, collapse = ", "), "\n", sep = "")
            cat("Branch tips: \n"); print( object@tips )
            invisible(NULL)
          })

#' Plot the data and the branchmodel object on a scatterplot (returned ggplot2 plot).
#'
#' Currently just plots the first two variables. 
#' Eventually might switch to plotting a projection onto a cleverly chosen plane.
plot_branchmodel = function( branchmodel, main = "" ){
  par = as.data.frame( rbind( branchmodel@center, branchmodel@tips) )
  embedding = branchmodel@raw_data[, 1:2]
  names( par ) = names(embedding) = c("X1", "X2")
  p = ggplot( ) + ggtitle( main ) +
    geom_point( aes( x = X1, y = X2, colour = factor( branch ) ),
                data = cbind( embedding, 
                              branch = branchmodel@assignments ) )+
    geom_point( aes(x = X1, y = X2), colour = "black", data = par) 
  
  pc_to_plot = c()
  for( i in 1:3){
    pc = branchmodel@models[[i]]
    data_i = data.frame( pc$s[pc$tag, 1:2] )
    data_i = cbind(data_i, branch = i)
    pc_to_plot = rbind( pc_to_plot, data_i)
  }
  p = p + geom_line ( mapping = aes( colour = factor( branch ),
                                     group  = factor( branch ), 
                                     x = x, y = y ), 
                      data = pc_to_plot )
  
  return(p)
}

# # Subset the data.
setGeneric( "subset", function( branchmodel, index_keep ) standardGeneric( "subset" ) )
setMethod(  "subset", valueClass = "branchmodel",
           signature = signature( branchmodel = "branchmodel", index_keep = "integer"),
           function             ( branchmodel, index_keep ){
  branchmodel@raw_data    = branchmodel@raw_data   [ index_keep, ]
  branchmodel@dist_df     = branchmodel@dist_df    [ index_keep, ]
  branchmodel@assignments = branchmodel@assignments[ index_keep ]
  assertthat::assert_that( get_issues( branchmodel ) == "")
  return(branchmodel)
})
```
